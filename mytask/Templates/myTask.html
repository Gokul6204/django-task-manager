{% load static %}
<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>My Tasks</title>
  <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}">
  <style>
    .task-title, .task-desc, .task-complete { vertical-align: middle; }
  </style>
</head>
<body>
<header class="py-3 border-bottom">
  <div class="container d-flex justify-content-between">
    <h3>Task Manager - {{ user.username }}</h3>
    <a href="{% url 'logout' %}" class="btn btn-outline-secondary btn-sm">Logout</a>
  </div>
</header>

<main class="container my-4">
  <div class="mb-3">
    <button id="addTaskBtn" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#taskModal">Add Task</button>
  </div>

  <div class="table-responsive">
    <table class="table table-bordered">
      <thead><tr><th>Title</th><th>Description</th><th>Complete</th><th>Actions</th></tr></thead>
      <tbody>
        {% for task in tasks %}
        <tr data-id="{{ task.id }}">
          <td class="task-title">{{ task.title }}</td>
          <td class="task-desc">{{ task.description }}</td>
          <td class="task-complete">{% if task.complete %}Yes{% else %}No{% endif %}</td>
          <td class="text-end">
            <button class="btn btn-sm btn-outline-secondary btn-edit" data-bs-toggle="modal" data-bs-target="#taskModal">Edit</button>
            <button class="btn btn-sm btn-outline-danger btn-delete">Delete</button>
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="4">No tasks yet.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</main>

<!-- Modal for Add/Edit -->
<div class="modal fade" id="taskModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <form class="modal-content" id="taskForm">
      {% csrf_token %}
      <div class="modal-header"><h5 id="taskModalLabel">Add Task</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <input type="hidden" id="taskId" value="">
        <div class="mb-2"><label>Title</label><input id="taskTitle" class="form-control" required></div>
        <div class="mb-2"><label>Description</label><textarea id="taskDesc" class="form-control"></textarea></div>
        <div class="form-check mb-2"><input id="taskComplete" type="checkbox" class="form-check-input"><label class="form-check-label">Complete</label></div>
      </div>
      <div class="modal-footer"><button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button><button type="submit" class="btn btn-primary">Save</button></div>
    </form>
  </div>
</div>

<script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>
<script>
const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
let editMode = false;
const modal = new bootstrap.Modal(document.getElementById('taskModal'));
const taskForm = document.getElementById('taskForm');
const taskIdEl = document.getElementById('taskId');
const titleEl = document.getElementById('taskTitle');
const descEl = document.getElementById('taskDesc');
const completeEl = document.getElementById('taskComplete');

// Reset modal for Add
document.getElementById('addTaskBtn').addEventListener('click', () => {
  editMode = false;
  taskForm.reset();
  taskIdEl.value = '';
  document.getElementById('taskModalLabel').innerText = 'Add Task';
});

// Submit Add or Edit
taskForm.addEventListener('submit', async (ev) => {
  ev.preventDefault();
  const payload = {
    id: taskIdEl.value || null,
    title: titleEl.value.trim(),
    description: descEl.value.trim(),
    complete: completeEl.checked
  };

  const url = editMode ? '/edit_task/' : '/add_task/';
  const res = await fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
    body: JSON.stringify(payload)
  });
  const result = await res.json();
  if (!result.success) { alert(result.error || 'Error'); return; }

  if (editMode) {
    const row = document.querySelector(`tr[data-id="${payload.id}"]`);
    row.querySelector('.task-title').textContent = result.title || payload.title;
    row.querySelector('.task-desc').textContent = result.description || payload.description;
    row.querySelector('.task-complete').textContent = (result.complete ? 'Yes' : 'No');
  } else {
    const tbody = document.querySelector('tbody');
    const row = document.createElement('tr');
    row.dataset.id = result.id;
    row.innerHTML = `
      <td class="task-title">${result.title}</td>
      <td class="task-desc">${result.description}</td>
      <td class="task-complete">${result.complete ? 'Yes' : 'No'}</td>
      <td class="text-end">
        <button class="btn btn-sm btn-outline-secondary btn-edit" data-bs-toggle="modal" data-bs-target="#taskModal">Edit</button>
        <button class="btn btn-sm btn-outline-danger btn-delete">Delete</button>
      </td>`;
    tbody.prepend(row);
  }
  modal.hide();
});

// Event delegation: Edit and Delete
document.addEventListener('click', async (e) => {
  // Edit
  if (e.target.classList.contains('btn-edit')) {
    editMode = true;
    const row = e.target.closest('tr');
    taskIdEl.value = row.dataset.id;
    titleEl.value = row.querySelector('.task-title').textContent.trim();
    descEl.value = row.querySelector('.task-desc').textContent.trim();
    completeEl.checked = row.querySelector('.task-complete').textContent.trim() === 'Yes';
    document.getElementById('taskModalLabel').innerText = 'Edit Task';
  }

  // Delete
  if (e.target.classList.contains('btn-delete')) {
    if (!confirm('Delete this task?')) return;
    const row = e.target.closest('tr');
    const id = row.dataset.id;
    const res = await fetch('/delete_task/', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
      body: JSON.stringify({ id })
    });
    const result = await res.json();
    if (result.success) row.remove();
    else alert(result.error || 'Failed to delete');
  }
});
</script>
</body>
</html>
